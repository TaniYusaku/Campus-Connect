### 1. プロジェクト概要

* **プロジェクト名（仮）**: Campus Connect（キャンパス・コネクト）
* **目的**: 同じ大学に通う学生同士が、物理的なすれ違いをきっかけに、匿名でつながる機会を提供する。
* **コンセプト**: 「リアル × デジタル」による、偶然の再会を重視した自然なマッチング体験。
* **対象ユーザー**: 同一大学の学生のみ。

### 2. 開発方針

* **MVP（Minimum Viable Product）開発**
    * まずは必要最小限の機能で迅速にリリースし、ユーザーの反応を計測します。改善や機能追加は、リリース後のアップデートで段階的に行います。
* **ユーザー認証**
    * 現行MVPはメール/パスワード認証を採用しています（`/api/auth/*`）。
    * 将来的に大学メールアドレスでの追加確認や強化策の導入を検討します。

### 3. 機能要件

#### 3.1. ユーザープロフィール
* **写真**: 1枚登録推奨（任意）。顔写真以外でも可。未設定の場合はプレースホルダーを表示します。
* **学部 / 学年**: 運営側が用意したリストから選択する必須項目です。
* **趣味**: 現在のMVPでは入力欄は提供していません（将来の拡張候補）。
* **自己紹介**: 自由記述（アプリ側でハードリミットは設けず、200字程度を目安とします）。
* **性別**: 「男性」「女性」「その他／回答しない」から選択します。
* **SNSアカウント**: 任意でX (旧Twitter)やInstagram等のIDを登録できます。
* **一覧フィルタ**: すれ違いタブでは「すべて / 男性 / 女性」のタブと、「同じ学部だけ」「同じ学年だけ」のチェックで表示対象を絞り込めます（学部・学年は必須入力）。

#### 3.2. BLEによるすれ違い検知
* **検知条件**: RSSIが概ね -80dBm 以上のデバイスを検出した際に観測イベントを送信します。サーバー側で5分以内の相互観測（互いに観測し合う）を検出できた場合のみ「すれ違い」として確定します。
* **一時識別子 (tempID)**: 端末ごとに15分周期で変化する一時的なIDを広告（Advertise）し、観測前に `register-tempid` API へ登録します。
* **観測イベント**: クライアントは検知ごとに `POST /api/encounters/observe` を呼び出し、サーバーは相互観測になったタイミングでEncounterエントリを作成します。クライアントから `POST /api/encounters` を直接呼び出すフローは採用していません。
* **履歴の仕様**:
    * すれ違い履歴は過去24時間分を保持します。
    * 同じ相手と複数回すれ違った場合は、最新のすれ違い情報で上書きされます（履歴には常に1件のみ表示）。

補足（実装状況メモ）
- フォアグラウンドでのスキャン/アドバタイズのみ対応します。OSポリシーとセキュリティ制約からバックグラウンド動作は実装対象外とします。
- 履歴24h保持はサーバ側`recentEncounters`に保存して返却。TTLの自動削除はサーバのTTLポリシー/定期ジョブで対応予定です。
- `recentEncounters` には `lastEncounteredAt` に加えて `encounterCount`（接触回数）を保存し、同じ相手とのすれ違い回数を把握できるようにします。

#### 3.3. いいね機能
* **完全匿名**: ユーザーはすれ違い履歴の相手に「いいね」ができますが、その事実は相手に一切通知されません。誰が自分に「いいね」したかもわかりません。

#### 3.4. マッチング（要件変更）
* **成立条件（更新）**: 相互に「いいね」した時点で、即時にマッチング（友達）成立とします。
* **再会時の通知（アプリ内）**: マッチ済みの2人が物理的に再度すれ違ったタイミングで、アプリ内に通知（バナーやモーダル）を表示します。
* **チャット機能**: **ありません**。マッチング後の交流は、プロフィールに登録されたSNSや、現実世界での接触に委ねます。

#### 3.5. 友達リスト
* マッチングが成立した相手が自動的に追加される専用リストです。
* 相手のプロフィール（SNSアカウント含む）をいつでも確認できます。
* リストから相手を削除する機能はなく、関係を断つにはブロック機能を利用します。

#### 3.6. ブロック機能
* ブロックしたこと、されたことは相手に通知されません。
* ブロックすると、以降のすれ違い検知から相互に除外され、成立していたマッチングも解消されます。
* MVPではブロック解除機能は提供しません（設定画面では参照のみ）。

#### 3.7. 通知機能（アプリ内のみ）
* **通知の表示方法**: 画面上部にポップアップ（バナー）を表示。OSのプッシュ通知は使用しません。
* **通知トリガー**:
    * 同じユーザーと2回目以降すれ違ったタイミング。
    * 新しく友達（マッチ）が成立したタイミング。
    * 既に友達になっているユーザーと再びすれ違ったタイミング。
* **その他のタイミング**（いいねされた時、初回すれ違い時など）での通知は行いません。

### 4. 非機能要件

* **技術スタック**
    * **UI**: Flutter (Dart)
* **BLE通信**: Flutterプラグイン利用（v0）
    * セントラル: flutter_blue_plus（スキャン主体）
    * ペリフェラル: ble_peripheral
    * バックグラウンド動作は対応対象外とし、フォアグラウンド時の体験品質を優先します。
    * **バックエンド**: Firebase + Node/Hono API
* **プライバシー設計**
    * BLE通信ではtempID以外の個人情報を一切送信しません。
    * MACアドレスのランダム化を行います。
    * ユーザー情報はすべてクラウド側（Firebase）で管理します。
* **パフォーマンス**
    * バッテリー消費と検知精度のバランスを重視し、フォアグラウンド動作に最適化します。バックグラウンド動作は行いません。
