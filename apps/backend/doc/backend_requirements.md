### 【詳細版】Campus Connect APIエンドポイント仕様

注記（実装との差分）
- 現行実装は Hono ベースで `/api` 配下に実装されています。
- 本書の一部パス例（例: `/encounters` や `/friends`）は、現行では `/api/users/encounters`、`/api/users/friends` のように `/users` 配下にあります。
- いいね取り消し（DELETE）は実装済みです（`/api/users/:userId/like`）。ただし現実装は「マッチ成立後は取り消し不可（ブロックで関係を解消）」となります。
- 公開プロフィール取得、ページネーションは今後対応予定です（デバイストークン登録は不要になりました）。
- `recentEncounters` サブコレクションには `lastEncounteredAt` と `encounterCount` を保持し、同じ相手との接触回数を追跡します。

#### 1. ユーザー認証 (Authentication)
* **POST `/auth/register`**
    * **利用する場面:** ユーザーがアプリの新規登録画面で、メールアドレス・パスワード・ニックネーム・性別を入力し、「登録」ボタンをタップした時。
    * **必要な理由:** 新しいユーザーアカウントを作成するため。このAPIがサービスの入り口となる。
    * **備考:** 登録成功時には、ユーザー情報と認証トークンを返すことで、登録と同時にログイン状態にすることが望ましい。パスワードは必ずハッシュ化して保存すること。

* **POST `/auth/login`**
    * **利用する場面:** 既存ユーザーがログイン画面でメールアドレスとパスワードを入力し、「ログイン」ボタンをタップした時。
    * **必要な理由:** 登録済みのユーザーを認証し、サービスの利用に必要な認証トークンを発行するため。
    * **備考:** 認証トークンには有効期限を設定し、クライアント側で安全に保管する必要がある。

#### 2. ユーザー情報 (User Profile & Management)
* **GET `/users/me`**
    * **利用する場面:** ユーザーが「マイページ」や「設定」画面を開き、自身のプロフィール情報を確認する時。
    * **必要な理由:** ログイン中のユーザー自身の完全なプロフィール情報（メールアドレス等を含む）を取得するため。
    * **備考:** 必ず認証トークンが必要な、保護されたAPIとすること。

* **PUT `/users/me`**
    * **利用する場面:** ユーザーがプロフィール編集画面で、自己紹介文や趣味などを変更し「保存」をタップした時。
    * **必要な理由:** ユーザーが自身のプロフィール情報を更新できるようにするため。
    * **備考:** 変更があった項目のみをリクエストボディに含めるPATCH形式の動作が効率的。MVPでは `userName / faculty / grade / bio / snsLinks / profilePhotoUrl / gender` といった主要項目のみを受け付けます（趣味タグなどは未対応）。

* **DELETE `/users/me`**
    * **利用する場面:** ユーザーが設定画面などから「アカウント削除」を選択し、最終確認ダイアログで承認した時。
    * **必要な理由:** ユーザー自身がサービスから退会する権利を保障するため。App Storeのガイドラインでも要求される。
    * **備考:** 現在はFirebase Authenticationのユーザーと `users/{userId}` ドキュメントを削除します。いいねやマッチ履歴の後片付けは順次対応予定です。将来的には関連データもまとめて削除/匿名化し、本人確認フローも追加します。

* **PUT `/users/me/device`**
    * **利用する場面:** 現行方針ではアプリ内通知のみを提供するため、このエンドポイントは不要です。
    * **備考:** プッシュ通知はサポート対象外のため、当面は実装しません。

* **GET `/users/{userId}`**
    * **利用する場面:** ユーザーが「友達リスト」から特定の相手を選択したり、マッチング通知をタップしたりした時。
    * **必要な理由:** 他のユーザーのプロフィール情報を画面に表示するため。
    * **備考:** 表示する情報は公開情報（ニックネーム、自己紹介、趣味など）に限定し、メールアドレスなどの個人情報は含めないこと。バックエンド側で、リクエスト元のユーザーが相手のプロフィールを閲覧する権限（＝マッチング済み）を持っているかチェックすることが望ましい。

#### 3. コアアクション (Core Actions)
* **POST `/encounters/observe`**
    * **利用する場面:** クライアントがBLEスキャンでCampus Connectデバイスを検知した瞬間に、観測したtempIdとRSSIを送信する。
    * **必要な理由:** サーバー側で相互観測（5分以内に両者がお互いを検出）が成立したタイミングでのみ正式なEncounterを生成し、重複通知を防ぐため。
    * **備考:** サーバーは `observations/{pair}` ドキュメントに最終観測時刻を記録し、相互観測かつクールダウン経過済みであれば `recentEncounters` と `encounterCount` を更新し、必要に応じてマッチ判定を行います。旧仕様で想定していた `POST /encounters` は現在は使用しません。

* **POST `/encounters/register-tempid`**
    * **利用する場面:** アプリが15分周期でtempIdをローテーションした際に、そのtempIdと有効期限をサーバーへ登録する。
    * **必要な理由:** 観測APIで受け取ったtempIdをユーザーIDへ解決するため。
    * **備考:** `tempIds/{tempId}` に `userId` と `expiresAt` を保存し、クライアントは毎回のローテーション時に登録します。

* **POST `/users/{userId}/like`**
    * **利用する場面:** ユーザーが「すれ違い履歴」画面で、気になる相手の「いいね」ボタンをタップした時。
    * **必要な理由:** 相手への関心を記録し、マッチングの第一歩とするため。
    * **備考:** サーバーはこのリクエストを受け取ると「いいね」を記録し、その時点でお互いに「いいね」し合っている状態（相互いいね）になったかをチェックする。

* **DELETE `/users/{userId}/like`**
    * **利用する場面:** ユーザーが間違って押した「いいね」を取り消したい時。UI上で「いいね済み」のボタンを再度タップするなどの操作が考えられる。
    * **必要な理由:** 操作ミスを訂正できるようにし、ユーザー体験を向上させるため。
    * **備考（現実装）:**
      - エンドポイントは `DELETE /api/users/{userId}/like`。
      - 未マッチ状態の「いいね」のみ削除可能。相互いいねでマッチ済みの場合は 409 を返し、ブロック機能の利用を促す。

* **POST `/users/{userId}/block`**
    * **利用する場面:** ユーザーが相手のプロフィール画面などから「ブロック」を選択した時。
    * **必要な理由:** ユーザーの安全と快適性を守るための重要なセーフティ機能。
    * **備考:** サーバー側では、マッチング情報・相互のいいね・マッチング待ち状態をすべて削除し、今後二者がすれ違っても検知対象から除外する、という一連の処理を確実に行う。



#### 4. 一覧取得 (List Retrieval)
* **GET `/encounters`**
    * **利用する場面:** アプリのメイン画面を開き、最近すれ違った人々のリストを表示する時。
    * **必要な理由:** ユーザーが「いいね」を送る相手を探すための、最も基本的な情報を提供するため。
    * **備考:** 現状は最新の最大30件を返すシンプルな一覧で、ページネーションパラメータは未対応。レスポンスには `lastEncounteredAt`（ISO8601文字列）、`encounterCount`（接触回数）、`isFriend`（友達状態）を含め、クライアント側で通知ロジックに利用します。将来的にクエリパラメータ付きのページングに対応する予定です。

* **GET `/friends`**
    * **利用する場面:** ユーザーがフッターメニューなどの「友達」タブをタップし、マッチングが成立した相手の一覧を見たい時。
    * **必要な理由:** マッチングした相手との繋がりを永続的に保持し、いつでもプロフィールを確認できるようにするため。
    * **備考:** 現状は全件返却（数十件規模想定）でページネーションは未実装。将来は `page / limit` 付きに差し替える。

* **GET `/blocked-users`**
    * **利用する場面:** ユーザーが設定画面から「ブロックしたユーザー」の管理画面を開いた時。
    * **必要な理由:** 自分が誰をブロックしているかを確認し、ブロック解除の操作を行えるようにするため。
    * **備考:** MVPでは閲覧のみでブロック解除は提供しません。ページネーションは未実装ですが、リスト規模が増えた時点で追加します。
